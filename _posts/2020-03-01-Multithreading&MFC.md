---
layout: post
title:  "多线程编程 & MFC 实现"
---

* content
{:toc}

## 多线程

首先介绍一下与多线程相关的一些基本知识。

**进程：**电脑中时会有很多单独运行的程序，每个程序有一个独立的进程，而进程之间是相互独立存在的。

**线程：**进程想要执行任务就需要依赖线程。换句话说，就是进程中的最小执行单位就是线程，并且一个进程中至少有一个线程。

<!-- more --> <!-- 摘要预览与正文的分隔符 -->

**多线程**

提到多线程这里要说两个概念，就是串行和并行。

串行：其实是相对于单条线程来执行多个任务来说的，我们就拿下载文件来举个例子：当我们下载多个文件时，在串行中它是按照一定的顺序去进行下载的，也就是说，必须等下载完A之后才能开始下载B，它们在时间上是不可能发生重叠的。

并行：下载多个文件，开启多条线程，多个文件同时进行下载，这里是严格意义上的，在同一时刻发生的，并行在时间上是重叠的。

**线程池**

线程池是一种多线程处理形式，处理过程中将任务添加到队列，然后在创建线程后自动启动这些任务。线程池线程都是后台线程。每个线程都使用默认的堆栈大小，以默认的优先级运行，并处于多线程单元中。如果某个线程在托管代码中空闲（如正在等待某个事件），则线程池将插入另一个辅助线程来使所有处理器保持繁忙。如果所有线程池线程都始终保持繁忙，但队列中包含挂起的工作，则线程池将在一段时间后创建另一个辅助线程但线程的数目永远不会超过最大值。超过最大值的线程可以排队，但他们要等到其他线程完成后才启动。

**线程安全**

当多个线程访问某个方法时，不管你通过怎样的调用方式、或者说这些线程如何交替地执行，我们在主程序中不需要去做任何的同步，这个类的结果行为都是我们设想的正确行为，那么我们就可以说这个类是线程安全的。

---

## MFC 实现多线程编程

MFC 中有两类线程，分别称之为工作者线程和用户界面线程。二者的主要区别在于工作者线程没有消息循环，而用户界面线程有自己的消息队列和消息循环。

工作者线程没有消息机制，通常用来执行后台计算和维护任务，如冗长的计算过程，打印机的后台打印等。用户界面线程一般用于处理独立于其他线程执行之外 的用户输入，响应用户及系统所产生的事件和消息等。但对于 Win32 的 API 编程而言，这两种线程是没有区别的，它们都只需线程的启动地址即可启动线程来 执行任务。

在 MFC 中，一般用全局函数 AfxBeginThread() 来创建并初始化一个线程的运行，该函数有两种重载形式，分别用于创建工作者线程和用户界面线程。

**工作者线程 AfxBeginThread() 原型**

```c++
CWinThread* AFXAPI AfxBeginThread(
    AFX_THREADPROC pfnThreadProc,
    LPVOID pParam,
    int nPriority,
    UINT nStackSize,
    DWORD dwCreateFlags,
    LPSECURITY_ATTRIBUTES lpSecurityAttrs);
```

> 各个参数功能详解如下：
>
> 参数1：线程的入口函数，返回值一定为 UINT，函数参数为：LPVOID，例如：UINT MyThreadFunction( LPVOID pParam )；
>
> 参数2 ：传递入线程的参数,注意它的类型为：LPVOID，所以我们可以传递一个结构体入线程；
>
> 参数3：指定线程优先级，如果为 0，则与创建该线程的线程相同；
>
> 参数4：指定线程的堆栈大小，如果为 0，则与创建该线程的线程相同；
>
> 参数5：创建标识，如果是 CREATE_SUSPENDED，则在悬挂状态创建线程，在线程创建后线程挂起，否则线程在创建后开始线程的执行；
>
> 参数6：表示线程的安全属性，NT 下有用。

**用户界面线程 AfxBeginThread() 原型**

```c++
CWinThread* AFXAPI AfxBeginThread(
    CRuntimeClass* pThreadClass,
    int nPriority,
    UINT nStackSize,
    DWORD dwCreateFlags,
    LPSECURITY_ATTRIBUTES lpSecurityAttrs);
```

> 各个参数功能详解如下：
>
> 参数1：是从 CWinThread 派生的 RUNTIME_CLASS 类；
>
> 参数2：指定线程优先级，如果为 0，则与创建该线程的线程相同；
>
> 参数3：指定线程的堆栈大小，如果为 0，则与创建该线程的线程相同；
>
> 参数4：是一个创建标识，如果是 CREATE_SUSPENDED，则在悬挂状态创建线程，在线程创建后线程挂起，否则线程在创建后开始线程的执行；
>
> 参数5：表示线程的安全属性，NT 下有用。



